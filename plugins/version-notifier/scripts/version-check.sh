#!/bin/bash
#
# version-check.sh
# Detect and notify about new Claude Code versions
#

set -e

# ===== Configuration =====
PLUGIN_DIR="$(cd "$(dirname "$0")/.." && pwd)"
CACHE_DIR="${PLUGIN_DIR}/.cache"
PENDING_UPGRADE_FILE="${CACHE_DIR}/pending-upgrade.json"
CHANGELOG_SUMMARY_FILE="${CACHE_DIR}/changelog-summary.json"

# ===== Initialization =====
mkdir -p "$CACHE_DIR"

# ===== JSON Output =====
output_json() {
  local system_msg="$1"
  local context_msg="${2:-}"

  if [ -n "$context_msg" ]; then
    jq -cn \
      --arg sys "$system_msg" \
      --arg ctx "$context_msg" \
      '{"systemMessage": $sys, "additionalContext": $ctx}'
  else
    jq -cn \
      --arg sys "$system_msg" \
      '{"systemMessage": $sys}'
  fi
}

# ===== Post-upgrade Summary Display =====
show_post_upgrade_summary() {
  if [ ! -f "$CHANGELOG_SUMMARY_FILE" ]; then
    return 1
  fi

  local info=$(cat "$CHANGELOG_SUMMARY_FILE")
  local prev_version=$(echo "$info" | jq -r '.previousVersion // "unknown"')
  local new_version=$(echo "$info" | jq -r '.latestVersion // "unknown"')
  local summary_raw=$(echo "$info" | jq -r '.summary // "Summary not available"')

  # Interpret ANSI escape sequences (\033 -> actual escape character)
  local summary=$(printf '%b' "$summary_raw")

  # Display the summary generated by Claude as-is
  local system_msg="$summary"

  # Context for Claude (for follow-up questions)
  local context_msg="[version-notifier] Claude Code has been upgraded from v${prev_version} to v${new_version}. The summary above has been displayed. If the user asks follow-up questions, refer to the changelog-interpreter skill for guidance."

  output_json "$system_msg" "$context_msg"

  # Delete file (display only once)
  rm -f "$CHANGELOG_SUMMARY_FILE"
  return 0
}

# ===== Version Retrieval =====
get_current_version() {
  claude --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1
}

get_latest_version() {
  npm show @anthropic-ai/claude-code version 2>/dev/null
}

# ===== Changelog Retrieval =====
get_changelog() {
  local release_info=$(curl -s "https://api.github.com/repos/anthropics/claude-code/releases/latest" 2>/dev/null)

  if [ -n "$release_info" ]; then
    echo "$release_info" | jq -r '.body // "Changelog not available"' 2>/dev/null | head -100
  else
    echo "Changelog not available. Please check: https://github.com/anthropics/claude-code/releases"
  fi
}

# ===== Save to pending-upgrade.json =====
save_pending_upgrade() {
  local current="$1"
  local latest="$2"
  local changelog="$3"

  jq -cn \
    --arg prev "$current" \
    --arg latest "$latest" \
    --arg changelog "$changelog" \
    '{
      "previousVersion": $prev,
      "latestVersion": $latest,
      "changelog": $changelog,
      "detectedAt": now | todate
    }' > "$PENDING_UPGRADE_FILE"
}

# ===== UI Notification =====
show_update_notification() {
  local current="$1"
  local latest="$2"

  # ANSI color codes (generate actual escape characters)
  local B=$'\033[1;34m'
  local O=$'\033[38;5;208m'

  local system_msg="
${B}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   New Claude Code version available!

   Current: v${current}  →  Latest: v${latest}

   Run ${O}/update-claude ${B}to upgrade.
${B}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  local context_msg="A new version v${latest} of Claude Code is available. The current version is v${current}. If the user wants to upgrade, guide them to use the /update-claude command."

  output_json "$system_msg" "$context_msg"
}

# ===== Main Process =====
main() {
  # First, check for post-upgrade summary display
  if show_post_upgrade_summary; then
    exit 0
  fi

  # Get versions
  local CURRENT_VERSION=$(get_current_version)
  local LATEST_VERSION=$(get_latest_version)

  # Compare versions (do nothing if same)
  if [ -z "$LATEST_VERSION" ] || [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
    echo '{}'
    exit 0
  fi

  # New version available - get changelog
  local CHANGELOG=$(get_changelog)

  # Save to pending-upgrade.json (for /upgrade skill)
  save_pending_upgrade "$CURRENT_VERSION" "$LATEST_VERSION" "$CHANGELOG"

  # Display notification in UI
  show_update_notification "$CURRENT_VERSION" "$LATEST_VERSION"

  exit 0
}

main
